---
# Apisix Application Template (Updated)
# Bu şablon, yeni deploy edilecek uygulamalar için Apisix Route kaynağını oluşturur.
# Şablon, trafiği doğrudan ilgili Kubernetes Service'ine yönlendirir.
#
# Template parametreleri:
# shopping-client - Uygulama ve Route adı için kullanılır
# shopping - Uygulamanın bulunduğu namespace
# 8080 - Kubernetes Service portu
# devopszon.com - Erişilecek host adı (örn: devopszon.com)
# ./shopping-client/apisix - Erişilecek path (örn: /api/benim-uygulamam)
# shopping-client - Hedef Kubernetes Service'in adı

apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: shopping-client-route
  namespace: shopping
spec:
  http:
  - name: shopping-client-rule
    match:
      hosts:
      - devopszon.com
      paths:
      # DİKKAT: Path'in sonuna "/*" eklenmesi, alt yolların da yakalanmasını sağlar.
      # Örneğin /api/app/* -> /api/app/login, /api/app/users gibi tüm istekleri karşılar.
      - ./shopping-client/apisix/*
    backends:
    # Trafik doğrudan Kubernetes Service'ine yönlendiriliyor.
    # ApisixUpstream veya ApisixService kaynağına gerek yoktur.
    - serviceName: shopping-client
      servicePort: 8080
      weight: 100
    plugins:
    # CORS (Cross-Origin Resource Sharing) ayarları
    - name: cors
      enable: true
      config:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,OPTIONS"
        allow_headers: "*"
    # Gelen isteğin path'ini yeniden yazarak servise doğru iletilmesini sağlar.
    # Örneğin: devopszon.com/api/app/login -> app-servisi:80/login
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri: ["^./shopping-client/apisix/(.*)", "/$1"]